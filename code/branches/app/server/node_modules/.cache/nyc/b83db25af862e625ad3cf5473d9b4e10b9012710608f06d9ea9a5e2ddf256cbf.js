var cov_1lkgk1uimf=function(){var path="/Applications/sandbox/msc_project/code/branches/app/server/routes/user.js";var hash="31e17b8ca5232d3a368f8fd4ab4677050c7e81e9";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/Applications/sandbox/msc_project/code/branches/app/server/routes/user.js",statementMap:{"0":{start:{line:1,column:16},end:{line:1,column:34}},"1":{start:{line:2,column:15},end:{line:2,column:31}},"2":{start:{line:3,column:15},end:{line:3,column:39}},"3":{start:{line:4,column:17},end:{line:4,column:36}},"4":{start:{line:5,column:12},end:{line:5,column:35}},"5":{start:{line:6,column:18},end:{line:6,column:43}},"6":{start:{line:8,column:17},end:{line:8,column:55}},"7":{start:{line:11,column:13},end:{line:11,column:38}},"8":{start:{line:14,column:0},end:{line:19,column:2}},"9":{start:{line:15,column:22},end:{line:15,column:30}},"10":{start:{line:16,column:19},end:{line:16,column:49}},"11":{start:{line:18,column:2},end:{line:18,column:58}},"12":{start:{line:22,column:0},end:{line:56,column:3}},"13":{start:{line:24,column:16},end:{line:24,column:30}},"14":{start:{line:25,column:19},end:{line:25,column:36}},"15":{start:{line:27,column:15},end:{line:32,column:4}},"16":{start:{line:31,column:4},end:{line:31,column:54}},"17":{start:{line:35,column:18},end:{line:35,column:74}},"18":{start:{line:37,column:2},end:{line:55,column:3}},"19":{start:{line:38,column:18},end:{line:40,column:6}},"20":{start:{line:43,column:4},end:{line:51,column:7}},"21":{start:{line:54,column:4},end:{line:54,column:76}},"22":{start:{line:59,column:0},end:{line:61,column:2}},"23":{start:{line:60,column:2},end:{line:60,column:31}},"24":{start:{line:65,column:0},end:{line:77,column:2}},"25":{start:{line:66,column:15},end:{line:66,column:42}},"26":{start:{line:68,column:19},end:{line:74,column:4}},"27":{start:{line:76,column:2},end:{line:76,column:48}},"28":{start:{line:79,column:0},end:{line:79,column:23}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:14,column:17},end:{line:14,column:18}},loc:{start:{line:14,column:37},end:{line:19,column:1}},line:14},"1":{name:"(anonymous_1)",decl:{start:{line:22,column:22},end:{line:22,column:23}},loc:{start:{line:22,column:42},end:{line:56,column:1}},line:22},"2":{name:"(anonymous_2)",decl:{start:{line:30,column:11},end:{line:30,column:12}},loc:{start:{line:30,column:20},end:{line:32,column:3}},line:30},"3":{name:"(anonymous_3)",decl:{start:{line:59,column:73},end:{line:59,column:74}},loc:{start:{line:59,column:87},end:{line:61,column:1}},line:59},"4":{name:"(anonymous_4)",decl:{start:{line:65,column:69},end:{line:65,column:70}},loc:{start:{line:65,column:89},end:{line:77,column:1}},line:65}},branchMap:{"0":{loc:{start:{line:37,column:2},end:{line:55,column:3}},type:"if",locations:[{start:{line:37,column:2},end:{line:55,column:3}},{start:{line:37,column:2},end:{line:55,column:3}}],line:37},"1":{loc:{start:{line:69,column:15},end:{line:69,column:71}},type:"cond-expr",locations:[{start:{line:69,column:36},end:{line:69,column:54}},{start:{line:69,column:57},end:{line:69,column:71}}],line:69},"2":{loc:{start:{line:70,column:14},end:{line:70,column:67}},type:"cond-expr",locations:[{start:{line:70,column:34},end:{line:70,column:51}},{start:{line:70,column:54},end:{line:70,column:67}}],line:70},"3":{loc:{start:{line:71,column:17},end:{line:71,column:79}},type:"cond-expr",locations:[{start:{line:71,column:40},end:{line:71,column:60}},{start:{line:71,column:63},end:{line:71,column:79}}],line:71},"4":{loc:{start:{line:72,column:12},end:{line:72,column:59}},type:"cond-expr",locations:[{start:{line:72,column:30},end:{line:72,column:45}},{start:{line:72,column:48},end:{line:72,column:59}}],line:72},"5":{loc:{start:{line:73,column:11},end:{line:73,column:55}},type:"cond-expr",locations:[{start:{line:73,column:28},end:{line:73,column:42}},{start:{line:73,column:45},end:{line:73,column:55}}],line:73}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0]},_coverageSchema:"43e27e138ebf9cfc5966b082cf9a028302ed4184",hash:"31e17b8ca5232d3a368f8fd4ab4677050c7e81e9"};var coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}return coverage[path]=coverageData;}();const express=(cov_1lkgk1uimf.s[0]++,require('express'));const router=(cov_1lkgk1uimf.s[1]++,express.Router());const bcrypt=(cov_1lkgk1uimf.s[2]++,require('bcrypt-nodejs'));const passport=(cov_1lkgk1uimf.s[3]++,require('passport'));const jwt=(cov_1lkgk1uimf.s[4]++,require('jsonwebtoken'));const promisify=(cov_1lkgk1uimf.s[5]++,require('util').promisify);const dbSecret=(cov_1lkgk1uimf.s[6]++,'9fa0fa96-7758-11e9-8f9e-2a86e4085a59');// models
const User=(cov_1lkgk1uimf.s[7]++,require('../models').user);// Create new user
cov_1lkgk1uimf.s[8]++;router.post('/',async(req,res)=>{cov_1lkgk1uimf.f[0]++;const requestBody=(cov_1lkgk1uimf.s[9]++,req.body);const response=(cov_1lkgk1uimf.s[10]++,await User.create(requestBody));cov_1lkgk1uimf.s[11]++;res.send({response:response,status:res.statusCode});});// User login
cov_1lkgk1uimf.s[12]++;router.post('/login',async(req,res)=>{cov_1lkgk1uimf.f[1]++;const email=(cov_1lkgk1uimf.s[13]++,req.body.email);const password=(cov_1lkgk1uimf.s[14]++,req.body.password);const user=(cov_1lkgk1uimf.s[15]++,await User.findOne({where:{email:email},raw:true}).catch(error=>{cov_1lkgk1uimf.f[2]++;cov_1lkgk1uimf.s[16]++;res.send({error:error,status:res.statusCode});}));const isMatch=(cov_1lkgk1uimf.s[17]++,await promisify(bcrypt.compare)(password,user.password));cov_1lkgk1uimf.s[18]++;if(isMatch){cov_1lkgk1uimf.b[0][0]++;const token=(cov_1lkgk1uimf.s[19]++,jwt.sign(user,dbSecret,{expiresIn:604800// 1 week
}));// Don't include the password in the returned user object
cov_1lkgk1uimf.s[20]++;return res.send({success:true,token:'JWT '+token,user:{id:user._id,name:user.name,email:user.email}});}else{cov_1lkgk1uimf.b[0][1]++;cov_1lkgk1uimf.s[21]++;return res.status(400).json({success:false,msg:'Wrong password.'});}});// get user profile
cov_1lkgk1uimf.s[22]++;router.get('/profile',passport.authenticate('jwt',{session:false}),(req,res)=>{cov_1lkgk1uimf.f[3]++;cov_1lkgk1uimf.s[23]++;res.send({user:req.user});});// update user profile
cov_1lkgk1uimf.s[24]++;router.put('/:id',passport.authenticate('jwt',{session:false}),async(req,res)=>{cov_1lkgk1uimf.f[4]++;const user=(cov_1lkgk1uimf.s[25]++,await User.findByPk(userId));const response=(cov_1lkgk1uimf.s[26]++,await user.update({firstName:req.body.firstName?(cov_1lkgk1uimf.b[1][0]++,req.body.firstName):(cov_1lkgk1uimf.b[1][1]++,user.firstName),lastName:req.body.lastName?(cov_1lkgk1uimf.b[2][0]++,req.body.lastName):(cov_1lkgk1uimf.b[2][1]++,user.lastName),dateOfBirth:req.body.dateOfBirth?(cov_1lkgk1uimf.b[3][0]++,req.body.dateOfBirth):(cov_1lkgk1uimf.b[3][1]++,user.dateOfBirth),gender:req.body.gender?(cov_1lkgk1uimf.b[4][0]++,req.body.gender):(cov_1lkgk1uimf.b[4][1]++,user.gender),email:req.body.email?(cov_1lkgk1uimf.b[5][0]++,req.body.email):(cov_1lkgk1uimf.b[5][1]++,user.email)}));cov_1lkgk1uimf.s[27]++;res.send({response,status:res.statusCode});});cov_1lkgk1uimf.s[28]++;module.exports=router;